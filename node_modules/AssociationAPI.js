////////////
// User API
////////////

// Uses User Mongoose model
var mongoose;
var Association;
var User;
var ObjectId;
var ObjectIdType;
exports.init = function(dataProvider) {
    mongoose = dataProvider;
    Association = mongoose.model('Association');
    User = mongoose.model('User');
    ObjectId = mongoose.Schema.ObjectId;
    ObjectIdType = mongoose.Types.ObjectId;
    return exports;
}
var sha512 = require('sha512-min.js');


/*
 Creates a new user in database if it doesn't already exists
 It first look up for existing user by email comparison
 */
exports.new = function(req){
    Association.findOne({ name: req.body.name }, function (err, a){
        /*
         If no association found,
         it creates new user based on Mongoose User model,
         then sets values from request to the new user
         */
        if (a == null) {

            // Creating new association model
            a = new Association();
            a.city = req.body.city;
            a.school = req.body.school;
            a.name = req.body.name;
            a.contact = req.body.contact.toLowerCase();
            User.findOne({ email: req.body.email }, '_id password', function(err, userData){
                if (!err) {
                    if (userData && userData.password == sha512.compute(req.body.password)) {
                        a.admins.push( userData );
                        a.save(function (err) {
                            if (!err) {
                                console.log('New registered association : ' + req.body.name + ' -> ' + req.body.contact);
                                return a;
                            }
                            else {
                                console.log('Error on association insertion : ' + err);
                                return null;
                            }
                        });
                    } else { console.log('user not found'); return null; }
                } else { console.log('error ' + err); return null; }

            });

            /*
             Now we can save the created user in the database
             */

            /*
             If a user if found, user registration function must stops
             */
        } else {
            console.log('Already existing association');
            // TODO: [MESSAGE] si l'association existe?
        }
    });
}

exports.populate = function(id) {
    Association.findOne({ _id: id })
        .populate('admins')
        .exec(function(err, asso){
            if (!err) { console.log('found : '); console.log(asso); }
            else console.log(err);
        });
}

/*exports.update = function(req) {
    User.findOne({ '_id': req.user._id }, function(err, user){
        user.firstname = req.body.firstname;
        user.lastname = req.body.lastname;
        user.email = req.body.email;
        user.city = req.body.city;
        user.save(function (err) {
            if (!err) {
                console.log('User successfully updated : ' + req.body.email);
            }
            else {
                console.log('Error on user update :' + err);
            }
        });
    });
}*/