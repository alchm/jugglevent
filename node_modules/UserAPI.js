////////////
// User API
////////////

// Uses User Mongoose model
var mongoose;
var User;
exports.init = function(dataProvider) {
    mongoose = dataProvider;
    User = mongoose.model('User');
    return exports;
}
var sha512 = require('sha512-min.js');


/*
 Creates a new user in database if it doesn't already exists
 It first look up for existing user by email comparison
 */
exports.new = function(req){
    User.findOne({ email: req.body.email }, function (err, user){
        /*
         If no user found,
         it creates new user based on Mongoose User model,
         then sets values from request to the new user
         */
        if (user == null) {

            // Creating new user model
            user = new User();

            // user.firstname is set by the firstname field from the form
            user.firstname = req.body.firstname;

            // user.lastname is set by the lastname field from the form
            user.lastname = req.body.lastname;

            /*
             TODO: THIS DO NOT ACTUALLY VERIFY IF THE USERNAME IS UNIQUE
             user.username is set by the lastname field from the form
             username MUST be unique, see form validator's regex
             */
            user.username = req.body.username;

            /*
             user.email is set by the email field from the form
             It use toLowerCase to provide unique email:
             "name@domain.com" is equivalent to "NaMe@DoMaIn.Com"
             */
            user.email = req.body.email.toLowerCase();

            /*
            user.city is set by the city selector from the form
             user.city MUST be an ObjectId referencing a cities document in database
             */
            user.city = req.body.city;

            /*
             user.password is set by the password field from the form
             It use sha512 module to compute a secure hashed password
             */
            user.password = sha512.compute(req.body.password);

            /*
             Now we can save the created user in the database
             */
            user.save(function (err) {
                if (!err) {
                    console.log('New registered user : ' + req.body.email);
                    return user;
                }
                else {
                    console.log('Error on user insertion');
                    return null;
                }
            });
        /*
         If a user if found, user registration function must stops
         */
        } else {
            console.log('already existing user');
            // TODO: [MESSAGE] si l'utilisateur existe?
        }
    });
}

exports.update = function(req) {
    User.findOne({ '_id': req.user._id }, function(err, user){
        user.firstname = req.body.firstname;
        user.lastname = req.body.lastname;
        user.email = req.body.email;
        user.city = req.body.city;
        user.save(function (err) {
            if (!err) {
                console.log('User successfully updated : ' + req.body.email);
            }
            else {
                console.log('Error on user update :' + err);
            }
        });
    });
}